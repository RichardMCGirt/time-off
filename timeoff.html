<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        nav ul {
            list-style-type: none;
            padding: 0;
            text-align: center;
        }
        nav ul li {
            display: inline;
            margin-right: 10px;
        }
        nav ul li a {
            text-decoration: none;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
        }
        nav ul li a:hover {
            background-color: #0056b3;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        form {
            margin-top: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .form-row label, .form-row input, .form-row button {
            margin-right: 10px;
        }
        input[type="number"] {
            width: 60px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .delete-button {
            background-color: #dc3545;
        }
        .delete-button:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="timesheet.html">Dashboard</a></li>
                <li><a href="timesheet.html#time-entry">Time Entry</a></li>
                <li><a href="timesheet.html#reports">TimeSheet</a></li>
                <li><a href="timeoff.html">Timeoff</a></li>
                <li><a href="login.html">Logout</a></li>
            </ul>
        </nav>
    </header>
    <h1>Welcome, <span id="user-name">{{ user.name }}</span></h1>
    <p>Email: <span id="user-email">{{ user.email }}</span></p>
    <p id="available-pto">Available Time Off: <span id="pto-balance">Loading...</span></p>

    <h2>Request Time Off</h2>
    <form id="time-off-form">
        <div id="form-rows-container">
            <div class="form-row" id="first-row">
                <label for="start-date">Start Date:</label>
                <input type="date" id="start-date" name="start_date[]" required>
                <label for="end-date">End Date:</label>
                <input type="date" id="end-date" name="end_date[]" required>
                <label for="hours">Hours per day:</label>
                <input type="number" id="hours-per-day" name="hours[]" min="0" max="24" step="1" required>
            </div>
        </div>
        <button type="button" id="add-more-fields">Add More</button>
        <button type="submit">Request Time Off</button>
    </form>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const userName = "{{ user.name }}";
            const userEmail = "{{ user.email }}";

            document.getElementById('user-name').textContent = userName;
            document.getElementById('user-email').textContent = userEmail;

            fetchPTO(userEmail);

            let fieldCounter = 0;
            const addMoreButton = document.getElementById('add-more-fields');
            addMoreButton.addEventListener('click', function() {
                if (fieldCounter < 10) {
                    const newField = `
                        <div class="form-row">
                            <label for="start-date">Start Date:</label>
                            <input type="date" name="start_date[]">
                            <label for="end-date">End Date:</label>
                            <input type="date" name="end_date[]">
                            <label for="hours">Hours per day:</label>
                            <input type="number" name="hours[]" min="0" max="24" step="1">
                            <button type="button" class="delete-button" onclick="deleteRow(this)">Delete</button>
                        </div>
                    `;
                    document.getElementById('form-rows-container').insertAdjacentHTML('beforeend', newField);
                    fieldCounter++;
                    if (fieldCounter === 10) {
                        addMoreButton.style.display = 'none';
                    }
                }
            });

            document.getElementById('time-off-form').addEventListener('submit', function(event) {
                event.preventDefault();
                const formData = new FormData(this);

                let totalHoursRequested = 0;
                formData.getAll('hours[]').forEach(hours => {
                    if (hours !== '') {
                        totalHoursRequested += parseInt(hours);
                    }
                });

                const currentPTO = parseFloat(document.getElementById('pto-balance').textContent);
                const newPTO = currentPTO - totalHoursRequested;

                updateAvailablePTO(newPTO);

                setTimeout(() => {
                    alert('Time off requested successfully');
                    window.location.reload();
                }, 1000);

                document.querySelectorAll('input[type="date"], input[type="number"]').forEach(input => {
                    input.value = '';
                });
                document.getElementById('form-rows-container').innerHTML = '';
                fieldCounter = 0;
                addMoreButton.style.display = 'block';
            });
        });

        function fetchPTO(email) {
            const apiKey = 'patlpJTj4IzTPxTT3.3de1a5fb5b5881b393d5616821ff762125f1962d1849879d0719eb3b8d580bde';
            const baseId = 'appMq9W12jZyCJeXe'; // Extracted base ID
            const tableName = 'tblRqUgMsd2QSd5ka'; // Extracted table ID

            fetch(`https://api.airtable.com/v0/${baseId}/${tableName}?filterByFormula=Email="${email}"`, {
                headers: {
                    Authorization: `Bearer ${apiKey}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const ptoBalance = data.records.length ? data.records[0].fields['Available Time Off'] : 0;
                document.getElementById('pto-balance').textContent = ptoBalance;
            })
            .catch(error => {
                console.error('Error fetching PTO data:', error);
                document.getElementById('pto-balance').textContent = 'Error loading PTO';
            });
        }

        function updateAvailablePTO(newBalance) {
            document.getElementById('pto-balance').textContent = newBalance;
        }

        function deleteRow(button) {
            const row = button.parentNode;
            if (!row.id || row.id !== 'first-row') {
                row.parentNode.removeChild(row);
                fieldCounter--;
                document.getElementById('add-more-fields').style.display = 'block';
            }
        }
    </script>
</body>
</html>
