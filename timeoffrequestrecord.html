<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Off Requests</title>
    <link rel="stylesheet" href="style.css"> <!-- Link to external CSS file -->
    <style>
        .request-item {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .request-item button {
            margin-top: 10px;
            background-color: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .request-item button.edit-btn {
            background-color: #4CAF50;
        }
        .request-item button.edit-btn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<header>
    <nav>
        <ul>
            <li><a href="timesheet.html">Dashboard</a></li>
            <li><a href="timesheet.html#time-entry">Time Entry</a></li>
            <li><a href="timeoff.html">Time Off</a></li>
            <li><a href="login.html">Logout</a></li>
        </ul>
    </nav>
</header>
<body>
    <h1 id="page-title">Time Off Requests</h1>

    <div id="time-off-requests"></div>

    <script>
        // Replace with your actual Airtable base ID and API key
        const apiKey = 'patlpJTj4IzTPxTT3.3de1a5fb5b5881b393d5616821ff762125f1962d1849879d0719eb3b8d580bde';
        const baseId = 'appMq9W12jZyCJeXe';
        const tableName = 'TimeOffRequests';

        // Function to fetch and display time off requests
        async function fetchTimeOffRequests() {
            const userEmail = sessionStorage.getItem('userEmail');
            if (!userEmail) {
                console.log('User not authenticated');
                return;
            }

            try {
                const response = await fetch(`https://api.airtable.com/v0/${baseId}/${tableName}?filterByFormula={user_email}="${userEmail}"`, {
                    headers: {
                        Authorization: `Bearer ${apiKey}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch time off requests');
                }

                const data = await response.json();
                if (data.records.length === 0) {
                    displayNoRecordsMessage();
                } else {
                    displayTimeOffRequests(data.records);
                }
            } catch (error) {
                console.error('Error fetching time off requests:', error);
            }
        }

        // Function to display "No records yet" message
        function displayNoRecordsMessage() {
            const container = document.getElementById('time-off-requests');
            container.innerHTML = '<p>No records yet</p>';
        }

        // Function to display time off requests on the page
        function displayTimeOffRequests(records) {
            const container = document.getElementById('time-off-requests');
            container.innerHTML = '';

            records.forEach(record => {
                const { fields, id } = record;
                const startDate = fields['Start Date'];
                const endDate = fields['End Date'];
                const personalTimeAdjusted = fields['Personal Time Adjusted'];

                const requestElement = document.createElement('div');
                requestElement.classList.add('request-item');
                requestElement.innerHTML = `
                    <p><strong>Start Date:</strong> ${startDate}</p>
                    <p><strong>End Date:</strong> ${endDate}</p>
                    <p><strong>Personal Time Adjusted:</strong> ${personalTimeAdjusted}</p>
                    <button class="edit-btn" onclick="editTimeOffRequest('${id}', '${startDate}', '${endDate}', '${personalTimeAdjusted}')">Edit</button>
                    <button onclick="deleteTimeOffRequest('${id}')">Delete</button>
                `;
                container.appendChild(requestElement);
            });
        }

        // Function to delete a time off request
        async function deleteTimeOffRequest(recordId) {
            try {
                const response = await fetch(`https://api.airtable.com/v0/${baseId}/${tableName}/${recordId}`, {
                    method: 'DELETE',
                    headers: {
                        Authorization: `Bearer ${apiKey}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to delete record');
                }

                alert('Time off request deleted successfully');
                // Refresh the list after deletion
                fetchTimeOffRequests();
            } catch (error) {
                console.error('Error deleting time off request:', error);
                alert('Failed to delete time off request');
            }
        }

        // Function to edit a time off request
        function editTimeOffRequest(recordId, startDate, endDate, personalTimeAdjusted) {
            // Example: Redirect to an edit page with pre-filled form fields
            // Replace with your own logic for editing
            alert(`Edit feature for record ID ${recordId}: Start Date: ${startDate}, End Date: ${endDate}, Personal Time Adjusted: ${personalTimeAdjusted}`);
        }

        // Fetch time off requests when the page loads
        fetchTimeOffRequests();
    </script>
</body>
</html>
